<base:BasePage
    x:Class="Sphere_Schedule_App.Views.Pages.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:base="using:Sphere_Schedule_App.Views.Pages"
    xmlns:converters="using:Sphere_Schedule_App.Converters"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:local="using:Sphere_Schedule_App.Views.Controls"
    xmlns:sys="using:System"
    Background="{StaticResource DashboardBackground}">

    <Page.Resources>
        <!-- Converters -->
        <converters:BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:DateTimeFormatConverter x:Key="DateTimeFormatConverter"/>
        <converters:StringToBrushConverter x:Key="StringToBrushConverter"/>
        <converters:ScoreToColorConverter x:Key="ScoreToColorConverter"/>
        <converters:StringFormatConverter x:Key="StringFormatConverter"/>
        <converters:NumberFormatConverter x:Key="NumberFormatConverter"/>
        <local:ProgressToDashArrayConverter x:Key="ProgressToDashArrayConverter"/>

        <!-- Data Templates -->
        <DataTemplate x:Key="StatCardTemplate">
            <Border Background="{StaticResource DashboardCard}"
                    CornerRadius="12"
                    Padding="20"
                    Margin="0,0,12,12"
                    Width="180"
                    Height="140">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Icon -->
                    <Border Background="{Binding Color, Converter={StaticResource StringToBrushConverter}}"
                            Width="40"
                            Height="40"
                            CornerRadius="20"
                            VerticalAlignment="Top">
                        <TextBlock Text="{Binding Icon}"
                                   FontSize="20"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Foreground="White"/>
                    </Border>

                    <!-- Value and Title -->
                    <StackPanel Grid.Row="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Value}"
                                   FontSize="28"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryDark}"/>
                        <TextBlock Text="{Binding Title}"
                                   FontSize="14"
                                   Foreground="{StaticResource TextSecondaryDark}"
                                   Margin="0,4,0,0"/>
                    </StackPanel>

                    <!-- Subtitle -->
                    <TextBlock Text="{Binding Subtitle}"
                               Grid.Row="2"
                               FontSize="11"
                               Foreground="{StaticResource TextTertiaryDark}"
                               Margin="0,4,0,0"/>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="AppointmentItemTemplate">
            <Border Background="{StaticResource DashboardCard}"
                    CornerRadius="10"
                    Padding="16"
                    Margin="0,0,0,8"
                    Height="80">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Time -->
                    <StackPanel Grid.Column="0" VerticalAlignment="Center" Margin="0,0,12,0">
                        <TextBlock Text="{Binding StartDateTime, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter='hh:mm'}"
                                   FontSize="16"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource DashboardPurple}"/>
                        <TextBlock Text="{Binding EndDateTime, Converter={StaticResource DateTimeFormatConverter}, ConverterParameter='hh:mm'}"
                                   FontSize="12"
                                   Foreground="{StaticResource TextTertiaryDark}"/>
                    </StackPanel>

                    <!-- Appointment Details -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding Title}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource TextPrimaryDark}"
                                   TextTrimming="CharacterEllipsis"/>
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,6,0,0">
                            <TextBlock Text="{Binding Location}"
                                       FontSize="12"
                                       Foreground="{StaticResource TextSecondaryDark}"
                                       TextTrimming="CharacterEllipsis"/>
                            <Border Background="{StaticResource DashboardGreen}"
                                    CornerRadius="4"
                                    Padding="4,2"
                                    Visibility="{Binding IsVirtual, Converter={StaticResource BoolToVisibility}}">
                                <TextBlock Text="Virtual"
                                           FontSize="10"
                                           Foreground="White"
                                           FontWeight="SemiBold"/>
                            </Border>
                        </StackPanel>
                    </StackPanel>

                    <!-- Status -->
                    <Border Grid.Column="2"
                            Background="{StaticResource DashboardBlue}"
                            CornerRadius="6"
                            Padding="8,4"
                            VerticalAlignment="Center">
                        <TextBlock Text="âœ“"
                                   FontSize="14"
                                   Foreground="White"
                                   FontWeight="Bold"/>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate x:Key="CategoryProgressTemplate">
            <Grid Width="160" Height="100" Margin="0,0,12,12">
                <!-- Background Arc -->
                <Path Stroke="{StaticResource BorderLight}"
                      StrokeThickness="8"
                      StrokeDashArray="0.75 0.25"
                      StrokeDashCap="Round">
                    <Path.Data>
                        <PathGeometry>
                            <PathFigure StartPoint="20,80">
                                <ArcSegment Point="140,80"
                                           Size="60,60"
                                           SweepDirection="Clockwise"/>
                            </PathFigure>
                        </PathGeometry>
                    </Path.Data>
                </Path>

                <!-- Progress Arc -->
                <Path Stroke="{Binding ColorCode, Converter={StaticResource StringToBrushConverter}}"
                      StrokeThickness="8"
                      StrokeDashCap="Round">
                    <Path.Data>
                        <PathGeometry>
                            <PathFigure StartPoint="20,80">
                                <ArcSegment Point="{Binding ProgressEndPoint}"
                                           Size="60,60"
                                           SweepDirection="Clockwise"/>
                            </PathFigure>
                        </PathGeometry>
                    </Path.Data>
                    <Path.StrokeDashArray>
                        <Binding Path="CompletionPercentage" Converter="{StaticResource ProgressToDashArrayConverter}"/>
                    </Path.StrokeDashArray>
                </Path>

                <!-- Percentage -->
                <TextBlock Text="{Binding CompletionPercentage, Converter={StaticResource NumberFormatConverter}}"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="{StaticResource TextPrimaryDark}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>

                <!-- Category Name -->
                <TextBlock Text="{Binding CategoryName}"
                           FontSize="12"
                           Foreground="{StaticResource TextSecondaryDark}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Bottom"
                           Margin="0,0,0,4"/>
            </Grid>
        </DataTemplate>
    </Page.Resources>

    <!-- Main Scrollable Content -->
    <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Quick Stats Cards - 4 CARDS AT TOP -->
            <Grid Grid.Row="0" Margin="0,0,0,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Total Tasks -->
                <Border Grid.Column="0"
                        Background="{StaticResource DashboardBlue}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,12,0">
                    <StackPanel>
                        <TextBlock Text="ðŸ“‹"
                                   FontSize="24"
                                   HorizontalAlignment="Left"/>
                        <TextBlock Text="{Binding Summary.TotalTasks}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   Margin="0,8,0,0"/>
                        <TextBlock Text="Total Tasks"
                                   FontSize="14"
                                   Foreground="White"
                                   Opacity="0.9"/>
                    </StackPanel>
                </Border>

                <!-- Completed Today -->
                <Border Grid.Column="1"
                        Background="{StaticResource DashboardGreen}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,12,0">
                    <StackPanel>
                        <TextBlock Text="âœ…"
                                   FontSize="24"
                                   HorizontalAlignment="Left"/>
                        <TextBlock Text="{Binding Summary.CompletedToday}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   Margin="0,8,0,0"/>
                        <TextBlock Text="Completed Today"
                                   FontSize="14"
                                   Foreground="White"
                                   Opacity="0.9"/>
                    </StackPanel>
                </Border>

                <!-- Today's Meetings -->
                <Border Grid.Column="2"
                        Background="{StaticResource DashboardPurple}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,12,0">
                    <StackPanel>
                        <TextBlock Text="ðŸ“…"
                                   FontSize="24"
                                   HorizontalAlignment="Left"/>
                        <TextBlock Text="{Binding Summary.TodayAppointments}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   Margin="0,8,0,0"/>
                        <TextBlock Text="Today's Meetings"
                                   FontSize="14"
                                   Foreground="White"
                                   Opacity="0.9"/>
                    </StackPanel>
                </Border>

                <!-- Productivity -->
                <Border Grid.Column="3"
                        Background="{StaticResource DashboardOrange}"
                        CornerRadius="12"
                        Padding="20">
                    <StackPanel>
                        <TextBlock Text="ðŸ“ˆ"
                                   FontSize="24"
                                   HorizontalAlignment="Left"/>
                        <TextBlock Text="{Binding Summary.ProductivityScore, Converter={StaticResource StringFormatConverter}, ConverterParameter='{}{0}%'}"
                                   FontSize="32"
                                   FontWeight="Bold"
                                   Foreground="White"
                                   Margin="0,8,0,0"/>
                        <TextBlock Text="Productivity"
                                   FontSize="14"
                                   Foreground="White"
                                   Opacity="0.9"/>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Main Dashboard Content -->
            <Grid Grid.Row="1" ColumnSpacing="24" RowSpacing="24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- LEFT COLUMN - Task Filter Panel -->
                <Border Grid.Column="0" Grid.Row="0" Grid.RowSpan="2"
                        Background="{StaticResource DashboardCard}"
                        CornerRadius="16"
                        Padding="0">
                    <local:TaskFilterPanel 
                        DataContext="{Binding TaskFilterPanelViewModel}"
                        VerticalAlignment="Stretch"
                        HorizontalAlignment="Stretch"
                        Margin="0"/>
                </Border>

                <!-- RIGHT COLUMN -->
                <StackPanel Grid.Column="1" Grid.Row="0" Spacing="24">

                    <!-- Quick Stats -->
                    <Border Background="{StaticResource DashboardCard}"
                            CornerRadius="16"
                            Padding="24">
                        <StackPanel Spacing="20">
                            <TextBlock Text="ðŸ“Š Quick Stats"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource TextPrimaryDark}"/>

                            <!-- Stats Grid -->
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Pending Tasks -->
                                <Border Grid.Row="0" Grid.Column="0"
                                        Background="{StaticResource DashboardHover}"
                                        CornerRadius="12"
                                        Padding="16"
                                        Margin="0,0,8,8">
                                    <StackPanel>
                                        <TextBlock Text="â³"
                                                   FontSize="20"/>
                                        <TextBlock Text="{Binding Summary.PendingTasks}"
                                                   FontSize="24"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource TextPrimaryDark}"
                                                   Margin="0,4,0,0"/>
                                        <TextBlock Text="Pending"
                                                   FontSize="12"
                                                   Foreground="{StaticResource TextSecondaryDark}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Overdue Tasks -->
                                <Border Grid.Row="0" Grid.Column="1"
                                        Background="{StaticResource DashboardHover}"
                                        CornerRadius="12"
                                        Padding="16"
                                        Margin="8,0,0,8">
                                    <StackPanel>
                                        <TextBlock Text="âš ï¸"
                                                   FontSize="20"/>
                                        <TextBlock Text="{Binding Summary.OverdueTasks}"
                                                   FontSize="24"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource DashboardRed}"
                                                   Margin="0,4,0,0"/>
                                        <TextBlock Text="Overdue"
                                                   FontSize="12"
                                                   Foreground="{StaticResource TextSecondaryDark}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Current Streak -->
                                <Border Grid.Row="1" Grid.Column="0"
                                        Background="{StaticResource DashboardHover}"
                                        CornerRadius="12"
                                        Padding="16"
                                        Margin="0,8,8,0">
                                    <StackPanel>
                                        <TextBlock Text="ðŸ”¥"
                                                   FontSize="20"/>
                                        <TextBlock Text="{Binding Summary.CurrentStreak}"
                                                   FontSize="24"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource DashboardOrange}"
                                                   Margin="0,4,0,0"/>
                                        <TextBlock Text="Day Streak"
                                                   FontSize="12"
                                                   Foreground="{StaticResource TextSecondaryDark}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Work Hours -->
                                <Border Grid.Row="1" Grid.Column="1"
                                        Background="{StaticResource DashboardHover}"
                                        CornerRadius="12"
                                        Padding="16"
                                        Margin="8,8,0,0">
                                    <StackPanel>
                                        <TextBlock Text="â±ï¸"
                                                   FontSize="20"/>
                                        <TextBlock Text="8.5h"
                                                   FontSize="24"
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource DashboardGreen}"
                                                   Margin="0,4,0,0"/>
                                        <TextBlock Text="Today"
                                                   FontSize="12"
                                                   Foreground="{StaticResource TextSecondaryDark}"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Focus Mode -->
                    <Border CornerRadius="16"
                            Padding="0">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource DashboardPurpleColor}" Offset="0"/>
                                <GradientStop Color="{StaticResource DashboardBlueColor}" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>
                        <StackPanel Spacing="16" Padding="24">
                            <TextBlock Text="ðŸŽ¯ Focus Mode"
                                       FontSize="18"
                                       FontWeight="Bold"
                                       Foreground="White"/>
                            <TextBlock Text="Deep Work Session"
                                       FontSize="14"
                                       Foreground="White"
                                       Opacity="0.9"/>
                            <TextBlock Text="55:00"
                                       FontSize="48"
                                       FontWeight="Bold"
                                       Foreground="White"
                                       HorizontalAlignment="Center"
                                       Margin="0,16,0,0"/>
                            <Button Content="Start Session"
                                   Background="White"
                                   Foreground="{StaticResource DashboardPurple}"
                                   CornerRadius="8"
                                   Padding="16,10"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Stretch"
                                   Margin="0,16,0,0"/>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- BOTTOM ROW - Category Progress -->
                <Border Grid.Column="1" Grid.Row="1"
                        Background="{StaticResource DashboardCard}"
                        CornerRadius="16"
                        Padding="24">
                    <StackPanel Spacing="16">
                        <TextBlock Text="ðŸ“ˆ Category Progress"
                                   FontSize="18"
                                   FontWeight="Bold"
                                   Foreground="{StaticResource TextPrimaryDark}"/>

                        <ItemsControl ItemsSource="{Binding CategoryProgress}"
                                      ItemTemplate="{StaticResource CategoryProgressTemplate}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapGrid Orientation="Horizontal"
                                              MaximumRowsOrColumns="2"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </Grid>

            <!-- Loading Indicator -->
            <!-- Loading Indicator -->
            <Border 
                Background="{StaticResource DashboardCard}"
                CornerRadius="16"
                Padding="40"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
                <StackPanel Spacing="16" HorizontalAlignment="Center">
                    <ProgressRing IsActive="True"
                      Width="40"
                      Height="40"
                      Foreground="{StaticResource DashboardBlue}"/>
                    <TextBlock Text="Loading your data..."
                   Foreground="{StaticResource TextSecondaryDark}"
                   HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
    </ScrollViewer>
</base:BasePage>